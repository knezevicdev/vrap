image: node:fermium

stages:
  - build
  - test

build-appraisal:
  only:
    refs:
      - merge_requests
    changes:
      - "**/*"
  stage: build
  script:
    - npm install --quiet
    - npm run lint
    - npm run build

test-appraisal:
  only:
    refs:
      - merge_requests
    changes:
      - "**/*"
  stage: test
  script:
    - npm install --quiet
    - npm run test:ci
  artifacts:
    when: always
    reports:
      junit:
        - junit.xml
      cobertura: coverage/cobertura-coverage.xml
    paths:
      -  coverage
  coverage: /All\sfiles.*?\s+(\d+.\d+)/

code_quality:
  rules:
    - if: '$CODE_QUALITY_DISABLED'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"' # Run code quality job in merge request pipelines
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'      # Run code quality job in pipelines on the master branch (but not in other branch pipelines)
    - if: '$CI_COMMIT_TAG'


include:
  - template: Jobs/Code-Quality.gitlab-ci.yml
  - template: Jobs/Code-Intelligence.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
