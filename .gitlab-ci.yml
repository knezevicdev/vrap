image: node:erbium

stages:
  - build
  - test

build-appraisal:
  only:
    refs:
      - merge_requests
    changes:
      - apps/appraisal/**/*
  stage: build
  script:
    - cd apps/appraisal
    - npm install --quiet
    - npm run lint
    - npm run build

lint-checkout:
  only:
    refs:
      - merge_requests
    changes:
      - apps/checkout/**/*
  stage: build
  script:
    - cd apps/checkout
    - npm install --quiet
    - npm run lint

build-checkout:
  only:
    refs:
      - merge_requests
    changes:
      - apps/checkout/**/*
  stage: build
  script:
    - cd apps/checkout
    - npm install --quiet
    - npm run build

build-home:
  only:
    refs:
      - merge_requests
    changes:
      - apps/home/**/*
  stage: build
  script:
    - cd apps/home
    - npm install --quiet
    - npm run lint
    - npm run build

build-landing:
  only:
    refs:
      - merge_requests
    changes:
      - apps/landing/**/*
  stage: build
  script:
    - cd apps/landing
    - npm install --quiet
    - npm run lint
    - npm run build

build-listing:
  only:
    refs:
      - merge_requests
    changes:
      - apps/listing/**/*
  stage: build
  script:
    - cd apps/listing
    - npm install --quiet
    - npm run lint
    - npm run build

test-listing:
  only:
    refs:
      - merge_requests
    changes:
      - apps/listing/**/*
  stage: build
  script:
    - cd apps/listing
    - npm install --quiet
    - npm run test:ci

build-logistics:
  only:
    refs:
      - merge_requests
    changes:
      - apps/logistics/**/*
  stage: build
  script:
    - cd apps/logistics
    - npm install --quiet
    - npm run build

lint-logistics:
  only:
    refs:
      - merge_requests
    changes:
      - apps/logistics/**/*
  stage: test
  script:
    - cd apps/logistics
    - npm install --quiet
    - npm run lint

test-logistics:
  only:
    refs:
      - merge_requests
    changes:
      - apps/logistics/**/*
  stage: test
  script:
    - cd apps/logistics
    - npm install --quiet
    - npm run test:ci
  artifacts:
    when: always
    reports:
      junit:
        - apps/logistics/junit.xml
      cobertura: apps/logistics/coverage/cobertura-coverage.xml
    paths:
      -  apps/logistics/coverage


build-marketing:
  only:
    refs:
      - merge_requests
    changes:
      - apps/marketing/**/*
  stage: build
  script:
    - cd apps/marketing
    - npm install --quiet
    - npm run lint
    - npm run build

build-product:
  only:
    refs:
      - merge_requests
    changes:
      - apps/product/**/*
  stage: build
  script:
    - cd apps/product
    - npm install --quiet
    - npm run lint
    - npm run build

test-product:
  only:
    refs:
      - merge_requests
    changes:
      - apps/product/**/*
  stage: test
  script:
    - cd apps/product
    - npm install --quiet
    - npm run test:ci
  artifacts:
    when: always
    reports:
      junit:
        - apps/product/junit.xml
      cobertura: apps/product/coverage/cobertura-coverage.xml
    paths:
      - apps/product/coverage


include:
  - template: Jobs/Test.gitlab-ci.yml
  - template: Jobs/Code-Quality.gitlab-ci.yml
  - template: Jobs/Code-Intelligence.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Jobs/Code-Intelligence.gitlab-ci.yml

